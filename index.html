<!DOCTYPE html>
<html lang="es" data-bs-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Territorios Jáuregui</title>
    <!-- CSS y Iconos -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
        body { transition: background-color 0.3s, color 0.3s; } .container { margin-top: 30px; } .table-responsive { box-shadow: 0 2px 10px rgba(0,0,0,0.1); } .table th { font-weight: 600; } .badge { font-size: 0.9em; padding: 0.5em 0.7em; } .btn-theme-toggle { font-size: 1.25rem; } .filter-panel { padding: 1.5rem; background-color: var(--bs-tertiary-bg); border-radius: 0.5rem; }
    </style>
</head>
<body>
    <div class="container">
        <!-- (El HTML del header no ha cambiado) -->
        <div class="d-flex justify-content-between align-items-center mb-4"><h1><i class="bi bi-map-fill me-2"></i>Control de Territorios Jáuregui</h1><div class="d-flex align-items-center"><button class="btn btn-outline-secondary btn-theme-toggle me-3" id="theme-toggler"><i class="bi bi-sun-fill"></i></button><button class="btn btn-success me-2" id="btn-pdf"><i class="bi bi-file-earmark-pdf-fill me-1"></i> Descargar PDF</button><a href="mapa.html" class="btn btn-info me-2">Ver Mapa Maestro</a><button class="btn btn-primary" id="add-territory-btn"><i class="bi bi-plus-circle me-1"></i> Añadir Territorio</button></div></div>
        <div class="filter-panel mb-4"><div class="row g-3 align-items-center"><div class="col-md-3"><select class="form-select" id="filter-estado"><option value="">Todos los Estados</option><option value="Pendiente">Pendiente</option><option value="Incompleto">Incompleto</option><option value="Completado">Completado</option></select></div><div class="col-md-3"><input type="text" class="form-control" id="filter-territorio" placeholder="Buscar por territorio..."></div><div class="col-md-3"><input type="text" class="form-control" id="filter-asignado" placeholder="Buscar por asignado..."></div><div class="col-md-3"><input type="text" class="form-control" id="filter-fecha" placeholder="Buscar por fecha (YYYY-MM-DD)..."></div></div></div>
        <div class="table-responsive"><table class="table table-striped table-hover align-middle" id="tabla-territorios"><thead class="table-dark"><tr><th>Mapa</th><th>Territorio</th><th>Asignado</th><th>Fecha</th><th>Estado</th><th>Cara faltante</th><th>Calle / Zona</th><th>Descripción</th><th>Acciones</th></tr></thead><tbody id="territorio-tbody"></tbody></table></div>
    </div>

    <!-- Modal para Añadir/Editar Territorio -->
    <div class="modal fade" id="territorioModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title" id="territorioModalLabel">Añadir Territorio</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <form id="territorioForm">
                        <div class="mb-3"><label class="form-label">Mapa</label><select class="form-select" id="territorio-mapa" required><option selected disabled value="">Selecciona un mapa...</option><option>Pueblo Nuevo</option><option>Las Casuarinas</option><option>Cortínez</option><option>Jáuregui</option><option>Barrio Loreto</option><option>Clotilde y Moras</option><option>El Pinar</option></select></div>
                        <!-- CAMBIO AQUÍ: Ahora es un select -->
                        <div class="mb-3"><label class="form-label">Número de Territorio</label><select class="form-select" id="territorio-num" required disabled><option selected disabled value="">Primero selecciona un mapa...</option></select></div>
                        <div class="mb-3"><label class="form-label">Asignado a</label><input type="text" class="form-control" id="territorio-asignado"></div><div class="mb-3"><label class="form-label">Fecha de Asignación</label><input type="date" class="form-control" id="territorio-fecha"></div><div class="mb-3"><label class="form-label">Estado</label><select class="form-select" id="territorio-estado"><option value="pendiente">Pendiente</option><option value="incompleto">Incompleto</option><option value="completado">Completado</option></select></div><div id="campos-incompletos-wrapper" style="display: none;"><div class="mb-3"><label class="form-label">Cara faltante</label><select class="form-select" id="territorio-cara"><option>Par</option><option>Impar</option></select></div><div class="mb-3"><label class="form-label">Calle / Zona</label><input type="text" class="form-control" id="territorio-calle"></div></div><div class="mb-3"><label class="form-label">Descripción</label><textarea class="form-control" id="territorio-desc" rows="3"></textarea></div>
                    </form>
                </div>
                <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button><button type="button" class="btn btn-primary" id="save-changes-btn">Guardar Cambios</button></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async function () {
            // --- CONFIGURACIÓN DE SUPABASE ---
            const SUPABASE_URL = 'https://kkbrarkletdjxludmzfy.supabase.co';
            const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtrYnJhcmtsZXRkanhsdWRtemZ5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgyMTExNjEsImV4cCI6MjA3Mzc4NzE2MX0.rAuD9BBBB6tSJ1jOL9t86je1oldk25n2WmDmehF-puA';
            const db = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

            // --- VARIABLES GLOBALES Y "LISTA MAESTRA" ---
            let allTerritories = [];
            const TERRITORIOS_POR_MAPA = {
                "Pueblo Nuevo": Array.from({length: 42 - 18 + 1}, (_, i) => 18 + i), // 18 al 42
                "Las Casuarinas": Array.from({length: 54 - 51 + 1}, (_, i) => 51 + i), // 51 al 54
                "Cortínez": Array.from({length: 49 - 43 + 1}, (_, i) => 43 + i),       // 43 al 49
                "Jáuregui": Array.from({length: 17 - 8 + 1}, (_, i) => 8 + i),         // 8 al 17
                "Barrio Loreto": Array.from({length: 4 - 1 + 1}, (_, i) => 1 + i),     // 1 al 4
                "Clotilde y Moras": Array.from({length: 7 - 5 + 1}, (_, i) => 5 + i), // 5 al 7
                "El Pinar": [50]
            };

            // --- SELECTORES ---
            const tableBody = document.getElementById('territorio-tbody');
            const saveChangesBtn = document.getElementById('save-changes-btn');
            const territorioForm = document.getElementById('territorioForm');
            const territorioModal = new bootstrap.Modal(document.getElementById('territorioModal'));
            const addTerritoryBtn = document.getElementById('add-territory-btn');
            const modalLabel = document.getElementById('territorioModalLabel');
            const mapSelect = document.getElementById('territorio-mapa');
            const numSelect = document.getElementById('territorio-num');

            // --- CARGAR DATOS ---
            async function loadTerritories() {
                const { data, error } = await db.from('territorios').select('*');
                if (error) { console.error('Error cargando territorios:', error); return; }
                allTerritories = data;
                renderTable(allTerritories);
            }

            // --- RENDERIZAR TABLA ---
            function renderTable(data) { /* (Sin cambios) */ tableBody.innerHTML = ''; data.forEach(t => { const newRow = tableBody.insertRow(); newRow.dataset.id = t.id; newRow.innerHTML = `<td>${t.mapa||'-'}</td><td>${t.territorio_num||'-'}</td><td>${t.asignado||'-'}</td><td>${t.fecha||'-'}</td><td>${getEstadoBadge(t.estado)}</td><td>${t.estado==='incompleto'?(t.cara_faltante||'-'):'-'}</td><td>${t.estado==='incompleto'?(t.calle_zona||'-'):'-'}</td><td>${t.descripcion||'-'}</td><td><button class="btn btn-sm btn-warning btn-edit"><i class="bi bi-pencil-fill"></i></button><button class="btn btn-sm btn-danger btn-delete"><i class="bi bi-trash-fill"></i></button></td>`; }); }

            // --- LÓGICA DEL FORMULARIO DINÁMICO ---
            mapSelect.addEventListener('change', () => {
                const selectedMap = mapSelect.value;
                if (!selectedMap) return;

                // 1. Obtener todos los números posibles para este mapa
                const allPossibleNumbers = TERRITORIOS_POR_MAPA[selectedMap] || [];

                // 2. Obtener los números que ya están en uso para este mapa
                const usedNumbers = allTerritories
                    .filter(t => t.mapa === selectedMap)
                    .map(t => t.territorio_num);

                // 3. Calcular los números disponibles
                const availableNumbers = allPossibleNumbers.filter(num => !usedNumbers.includes(num));

                // 4. Llenar el dropdown de números
                numSelect.innerHTML = '<option selected disabled value="">Selecciona un número...</option>';
                availableNumbers.forEach(num => {
                    numSelect.innerHTML += `<option value="${num}">${num}</option>`;
                });
                numSelect.disabled = false;
            });
            
            addTerritoryBtn.addEventListener('click', () => {
                territorioForm.reset();
                modalLabel.textContent = 'Añadir Territorio';
                numSelect.innerHTML = '<option selected disabled value="">Primero selecciona un mapa...</option>';
                numSelect.disabled = true;
                territorioModal.show();
            });

            // --- GUARDAR TERRITORIO ---
            saveChangesBtn.addEventListener('click', async function() { if (!territorioForm.checkValidity()) { territorioForm.reportValidity(); return; } const getValueOrNull = (id) => { const value = document.getElementById(id).value; return value === '' ? null : value; }; const newTerritory = { mapa: getValueOrNull('territorio-mapa'), territorio_num: getValueOrNull('territorio-num'), asignado: getValueOrNull('territorio-asignado'), fecha: getValueOrNull('territorio-fecha'), estado: getValueOrNull('territorio-estado'), cara_faltante: getValueOrNull('territorio-cara'), calle_zona: getValueOrNull('territorio-calle'), descripcion: getValueOrNull('territorio-desc') }; const { error } = await db.from('territorios').insert([newTerritory]); if (error) { console.error('Error al guardar:', error); alert('Hubo un error al guardar.'); } else { territorioForm.reset(); territorioModal.hide(); await loadTerritories(); } });

            // --- BORRAR Y EDITAR ---
            // (La lógica de borrar y editar no necesita cambios para esta funcionalidad)
            tableBody.addEventListener('click', async function(event) { const deleteButton = event.target.closest('.btn-delete'); if (deleteButton) { const row = deleteButton.closest('tr'); const territoryId = row.dataset.id; if (confirm('¿Estás seguro?')) { const { error } = await db.from('territorios').delete().eq('id', territoryId); if (error) { console.error('Error al borrar:', error); } else { await loadTerritories(); } } } });

            // --- CÓDIGO DE UTILIDADES ---
            const themeToggler = document.getElementById('theme-toggler'); const pdfButton = document.getElementById('btn-pdf'); const territorioModalEl = document.getElementById('territorioModal'); const estadoSelect = document.getElementById('territorio-estado'); const incompleteFieldsWrapper = document.getElementById('campos-incompletos-wrapper'); const filterEstado = document.getElementById('filter-estado'); const filterTerritorio = document.getElementById('filter-territorio'); const filterAsignado = document.getElementById('filter-asignado'); const filterFecha = document.getElementById('filter-fecha'); const themeIcon = themeToggler.querySelector('i'); const currentTheme = localStorage.getItem('theme') || 'light'; document.documentElement.setAttribute('data-bs-theme', currentTheme); updateThemeIcon(currentTheme); themeToggler.addEventListener('click', () => { let newTheme = document.documentElement.getAttribute('data-bs-theme') === 'dark' ? 'light' : 'dark'; document.documentElement.setAttribute('data-bs-theme', newTheme); localStorage.setItem('theme', newTheme); updateThemeIcon(newTheme); }); function updateThemeIcon(theme) { themeIcon.className = theme === 'dark' ? 'bi bi-moon-stars-fill' : 'bi bi-sun-fill'; } function toggleIncompleteFields() { incompleteFieldsWrapper.style.display = (estadoSelect.value === 'incompleto') ? 'block' : 'none'; } estadoSelect.addEventListener('change', toggleIncompleteFields); territorioModalEl.addEventListener('show.bs.modal', toggleIncompleteFields);
            pdfButton.addEventListener('click', function () { const { jsPDF } = window.jspdf; const doc = new jsPDF(); const headers = Array.from(document.querySelectorAll('#tabla-territorios thead th')).map(th => th.textContent).slice(0, -1); const body = Array.from(document.querySelectorAll('#tabla-territorios tbody tr')).filter(r => r.style.display !== 'none').map(r => Array.from(r.querySelectorAll('td')).map(td => td.textContent).slice(0, -1)); doc.autoTable({ head: [headers], body: body, startY: 20, headStyles: { fillColor: [41, 49, 51] }, didDrawPage: (data) => { doc.setFontSize(18); doc.text("Reporte de Territorios - Congregación Jáuregui", data.settings.margin.left, 15); } }); doc.save('reporte-territorios-jauregui.pdf'); });
            function getEstadoBadge(estado) { switch(estado) { case 'completado': return '<span class="badge bg-success">Completado</span>'; case 'incompleto': return '<span class="badge bg-danger">Incompleto</span>'; default: return '<span class="badge bg-warning text-dark">Pendiente</span>'; } }
            function filterTable() { const vE=filterEstado.value,vT=filterTerritorio.value.toLowerCase(),vA=filterAsignado.value.toLowerCase(),vF=filterFecha.value.toLowerCase(); tableBody.querySelectorAll('tr').forEach(row => { const cE=row.cells[4].textContent.trim(),cT=row.cells[1].textContent.toLowerCase(),cA=row.cells[2].textContent.toLowerCase(),cF=row.cells[3].textContent.toLowerCase(); const mE=vE===''||cE===vE,mT=cT.startsWith(vT),mA=cA.includes(vA),mF=cF.includes(vF); row.style.display = mE&&mT&&mA&&mF ? '' : 'none'; }); } filterEstado.addEventListener('change', filterTable); filterTerritorio.addEventListener('input', filterTable); filterAsignado.addEventListener('input', filterTable); filterFecha.addEventListener('input', filterTable);

            // --- INICIAR LA APLICACIÓN ---
            await loadTerritories();
        });
    </script>
</body>
</html>
