<!DOCTYPE html>
<html lang="es" data-bs-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa Maestro de Territorios</title>
    <!-- CSS de Bootstrap y Leaflet -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body, html { height: 100%; margin: 0; padding: 0; display: flex; flex-direction: column; }
        #map-container { flex-grow: 1; display: flex; }
        #map { width: 100%; height: 100%; }
        #sidebar { width: 350px; background-color: var(--bs-body-bg); padding: 1rem; overflow-y: auto; border-left: 1px solid var(--bs-border-color); }
        .list-group-item { cursor: pointer; }
        .list-group-item:hover { background-color: var(--bs-secondary-bg); }
        .list-group-header { font-weight: bold; background-color: var(--bs-tertiary-bg); margin-top: 1rem; padding: 0.5rem 1rem; border-radius: 0.25rem; }
        .file-input-wrapper { position: relative; overflow: hidden; display: inline-block; }
        .file-input-wrapper input[type=file] { font-size: 100px; position: absolute; left: 0; top: 0; opacity: 0; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg bg-body-tertiary shadow-sm">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">Mapa Maestro</a>
            <a href="index.html" class="btn btn-outline-primary">Ver Tabla de Territorios</a>
        </div>
    </nav>

    <div id="map-container">
        <div id="sidebar">
            <h4>Territorios</h4>
            <div class="file-input-wrapper btn btn-warning w-100 mb-3">
                <span>Importar KML de Google Maps</span>
                <input type="file" id="kml-importer" accept=".kml">
            </div>
            <div class="mb-3">
                <input type="text" id="search-territory" class="form-control" placeholder="Buscar por número...">
            </div>
            <div id="territory-list-container">
                <!-- La lista agrupada se generará aquí -->
            </div>
        </div>
        <div id="map"></div>
    </div>

    <!-- Modal de Progreso -->
    <div class="modal fade" id="progressModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-body text-center"><div class="spinner-border text-primary" role="status"></div><p class="mt-3" id="progress-text">Procesando...</p></div></div></div></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/togeojson@0.16.0/togeojson.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            // --- CONFIGURACIÓN DE SUPABASE Y LEAFLET ---
            const SUPABASE_URL = 'https://kkbrarkletdjxludmzfy.supabase.co';
            const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtrYnJhcmtsZXRkanhsdWRtemZ5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgyMTExNjEsImV4cCI6MjA3Mzc4NzE2MX0.rAuD9BBBB6tSJ1jOL9t86je1oldk25n2WmDmehF-puA';
            const db = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

            const map = L.map('map').setView([-34.78, -59.08], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors' }).addTo(map);

            let allTerritories = [];
            let drawnLayers = new L.FeatureGroup().addTo(map);
            
            // --- LÓGICA DE IMPORTACIÓN KML (Simplificada) ---
            const kmlImporter = document.getElementById('kml-importer');
            const progressModal = new bootstrap.Modal(document.getElementById('progressModal'));
            const progressText = document.getElementById('progress-text');
            kmlImporter.addEventListener('change', async function(event) { const file = event.target.files[0]; if (!file) return; progressModal.show(); progressText.textContent = `Procesando: ${file.name}...`; const reader = new FileReader(); reader.onload = async function(e) { try { const kmlText = e.target.result; const kml = new DOMParser().parseFromString(kmlText, 'text/xml'); const geoJson = toGeoJSON.kml(kml); const updates = []; geoJson.features.forEach(feature => { const territoryName = feature.properties.name || ''; const territoryNumMatch = territoryName.match(/\d+/); if (!territoryNumMatch) return; const territoryNum = territoryNumMatch[0]; const territory = allTerritories.find(t => t.territorio_num == territoryNum); if (territory && feature.geometry) { updates.push({ id: territory.id, geometria: feature.geometry }); } }); if (updates.length === 0) { alert(`No se encontraron territorios coincidentes en "${file.name}".`); return; } progressText.textContent = `Actualizando ${updates.length} territorios...`; const { error } = await db.from('territorios').upsert(updates); if (error) { console.error("Error:", error); alert("Hubo un error al guardar."); } else { alert(`¡Éxito! Se importaron ${updates.length} formas.`); await initialize(); } } catch (e) { console.error("Error KML:", e); alert("El archivo KML parece tener un formato incorrecto."); } finally { progressModal.hide(); event.target.value = ''; } }; reader.readAsText(file); });
            
            // --- CARGA Y RENDERIZADO INICIAL ---
            async function initialize() {
                const { data, error } = await db.from('territorios').select('*').order('mapa').order('territorio_num', { ascending: true });
                if (error) { console.error("Error al cargar:", error); return; }
                allTerritories = data;
                renderTerritoryList(allTerritories);
                drawAllShapes();
            }

            // --- FUNCIÓN DE RENDERIZADO DE LISTA (MEJORADA) ---
            function renderTerritoryList(territories) {
                const container = document.getElementById('territory-list-container');
                container.innerHTML = '';
                const groupedByMap = territories.reduce((acc, t) => { if (!t.mapa) return acc; if (!acc[t.mapa]) acc[t.mapa] = []; acc[t.mapa].push(t); return acc; }, {});

                for (const mapName in groupedByMap) {
                    const header = document.createElement('div');
                    header.className = 'list-group-header';
                    header.textContent = mapName;
                    container.appendChild(header);

                    const listGroup = document.createElement('ul');
                    listGroup.className = 'list-group mb-2';
                    
                    groupedByMap[mapName].forEach(t => {
                        const li = document.createElement('li');
                        li.className = 'list-group-item d-flex justify-content-between align-items-center';
                        const shapeIcon = t.geometria ? '<i class="bi bi-check-circle-fill text-success"></i>' : '<i class="bi bi-x-circle text-danger"></i>';
                        // ¡LA LÍNEA CORREGIDA ESTÁ AQUÍ!
                        li.innerHTML = `<span>Nº ${t.territorio_num}</span> ${shapeIcon}`;
                        listGroup.appendChild(li);
                    });
                    container.appendChild(listGroup);
                }
            }

            // --- DIBUJAR FORMAS Y DEMÁS FUNCIONES (SIN CAMBIOS) ---
            function drawAllShapes() { drawnLayers.clearLayers(); let bounds; allTerritories.forEach(t => { if (t.geometria) { const layer = L.geoJSON(t.geometria, { style: getStyleByStatus(t.estado) }).bindPopup(`<b>Territorio Nº ${t.territorio_num}</b><br>${t.mapa}<br>Estado: ${t.estado || 'Disponible'}`); drawnLayers.addLayer(layer.getLayers()[0]); if (!bounds) { bounds = layer.getBounds(); } else { bounds.extend(layer.getBounds()); } } }); if(bounds && bounds.isValid()) { map.fitBounds(bounds); } }
            function getStyleByStatus(status) { switch (status) { case 'completado': return { color: '#28a745', weight: 2, fillOpacity: 0.3 }; case 'pendiente': return { color: '#ffc107', weight: 2, fillOpacity: 0.3 }; case 'incompleto': return { color: '#dc3545', weight: 2, fillOpacity: 0.3 }; default: return { color: '#6c757d', weight: 2, fillOpacity: 0.3 }; } }
            document.getElementById('search-territory').addEventListener('input', (e) => { const searchTerm = e.target.value.toLowerCase(); const filtered = allTerritories.filter(t => t.territorio_num.toString().toLowerCase().includes(searchTerm)); renderTerritoryList(filtered); });
            
            initialize();
        });
    </script>
</body>
</html>
